<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="../../../favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="content-security-policy" content="" />
    <title>ラズパイ部室モニタについて :: d3bu.net</title>
    <meta name="description" content="神戸高専電算部のウェブサイト" data-svelte="svelte-9jvxrg" />
    <meta name="author" content="KCCTdensan" data-svelte="svelte-9jvxrg" />
    <meta name="keywords" content="電算部,電子計算機部,神戸高専,KCCT,高専" data-svelte="svelte-9jvxrg" />
    <meta name="robots" content="none" data-svelte="svelte-9jvxrg" />
    <meta name="twitter:card" content="summary" data-svelte="svelte-9jvxrg" />
    <meta name="twitter:site" content="@kcct_densan" data-svelte="svelte-9jvxrg" />
    <meta name="twitter:creator" content="@kcct_densan" data-svelte="svelte-9jvxrg" />
    <meta property="og:title" content="ラズパイ部室モニタについて :: d3bu.net" data-svelte="svelte-9jvxrg" />
    <meta property="og:type" content="website" data-svelte="svelte-9jvxrg" />
    <meta property="og:url" content="https://d3bu.net/inner/infra/rpi-busitsu/" data-svelte="svelte-9jvxrg" />
    <meta property="og:image" content="https://d3bu.net/icon.png" data-svelte="svelte-9jvxrg" />
    <meta property="og:description" content="神戸高専電算部のウェブサイト" data-svelte="svelte-9jvxrg" />
    <meta property="og:site_name" content="電算部.net" data-svelte="svelte-9jvxrg" />
    <link rel="stylesheet" href="/_app/immutable/assets/pages/__layout.svelte-4ca21928.css" />
    <link rel="stylesheet" href="/_app/immutable/assets/meta-451dd010.css" />
    <link rel="modulepreload" href="/_app/immutable/start-6f4837fc.js" />
    <link rel="modulepreload" href="/_app/immutable/chunks/index-ee3c2835.js" />
    <link rel="modulepreload" href="/_app/immutable/pages/__layout.svelte-532884a8.js" />
    <link rel="modulepreload" href="/_app/immutable/chunks/stores-939f4b6a.js" />
    <link rel="modulepreload" href="/_app/immutable/pages/inner/infra/_...slug_.svelte-ffddea15.js" />
    <link rel="modulepreload" href="/_app/immutable/chunks/articles-6663f4d8.js" />
    <link rel="modulepreload" href="/_app/immutable/chunks/md_layout-bf771c19.js" />
    <link rel="modulepreload" href="/_app/immutable/chunks/meta-2e624d54.js" />
    <script>
      function setViewportProperty(doc) {
        var prevClientHeight
        function handleResize() {
          var clientHeight = doc.clientHeight
          if (clientHeight === prevClientHeight) return
          requestAnimationFrame(function updateViewportHeight() {
            doc.style.setProperty("--vh", clientHeight * 0.01 + "px")
            prevClientHeight = clientHeight
          })
        }
        handleResize()
        return handleResize
      }
      window.addEventListener("resize", setViewportProperty(document.documentElement))
    </script>
  </head>
  <body>
    <div class="app svelte-muqni6">
      <div class="container svelte-muqni6">
        <header class="header svelte-1a9xnuw">
          <div class="headerLogo svelte-1a9xnuw">
            <a class="logo svelte-1a9xnuw" href="/"
              ><img class="icon svelte-1a9xnuw" src="/icon.png" alt="Logo" />
              <span class="text svelte-1a9xnuw"
                ><span class="inline-block svelte-1a9xnuw">神戸</span><span class="inline-block svelte-1a9xnuw">高専</span><span class="inline-block svelte-1a9xnuw">電算部</span></span
              ></a
            >
            <div class="pkgInfo svelte-1a9xnuw">
              <span class="svelte-1a9xnuw">/api/package.json</span> <span class="svelte-1a9xnuw">{&quot;name&quot;:&quot;d3bu.net&quot;,&quot;version&quot;:&quot;2.1.1&quot;}</span>
            </div>
          </div>
          <nav class="headerNav svelte-1a9xnuw">
            <span class="svelte-1a9xnuw">&gt; ls /</span>
            <ul class="navLinks svelte-1a9xnuw">
              <li class="svelte-1a9xnuw"><a sveltekit:prefetch href="/" class="svelte-1a9xnuw">Top</a></li>
              <li class="svelte-1a9xnuw"><a sveltekit:prefetch href="/about/" class="svelte-1a9xnuw">About</a></li>
              <li class="svelte-1a9xnuw"><a sveltekit:prefetch href="/blog/" class="svelte-1a9xnuw">Blog</a></li>
              <li class="svelte-1a9xnuw"><a sveltekit:prefetch href="/works/" class="svelte-1a9xnuw">Works</a></li>
              <li class="svelte-1a9xnuw"><a sveltekit:prefetch href="/dev/" class="svelte-1a9xnuw">Dev</a></li>
              <li class="svelte-1a9xnuw active"><a sveltekit:prefetch href="/inner/" class="svelte-1a9xnuw">Inner</a></li>
              <li class="svelte-1a9xnuw"><a sveltekit:prefetch href="/joinus/" class="svelte-1a9xnuw">JoinUs</a></li>
              <li class="svelte-1a9xnuw"><a href="http://www.kobe-kosen.ac.jp" target="_blank" rel="external" class="svelte-1a9xnuw">KCCT</a></li>
            </ul>
            <span class="svelte-1a9xnuw">&gt; pwd</span>
            <ul class="breadcrumbs svelte-1a9xnuw">
              <li class="svelte-1a9xnuw"><a href="/" class="svelte-1a9xnuw">/</a></li>
              <li class="svelte-1a9xnuw"><a href="/inner/" class="svelte-1a9xnuw">inner/</a></li>
              <li class="svelte-1a9xnuw"><a href="/inner/infra/" class="svelte-1a9xnuw">infra/</a></li>
              <li class="svelte-1a9xnuw"><a href="/inner/infra/rpi-busitsu/" class="svelte-1a9xnuw">rpi-busitsu/</a></li>
            </ul>
            <span class="svelte-1a9xnuw">&gt; echo $PLATFORM</span>
            <span class="svelte-1a9xnuw">gh-pages</span>
            <span class="svelte-1a9xnuw">&gt; _</span>
          </nav>
        </header>

        <div>
          <div class="meta svelte-y63w9z">
            <span>meta = {</span>
            <span class="iter svelte-y63w9z"
              ><span class="svelte-y63w9z">post: &quot;<time datetime="2022-03-13T00:00:00.000Z">2022/03/13</time>&quot;</span>
            </span>
            <span>};</span>
          </div>

          <hr />

          <main class="main-normal">
            <!-- HTML_TAG_START -->
            <h1 id="ラズパイ部室モニタについて">ラズパイ部室モニタについて</h1>
            <p>リポジトリ : <a href="https://github.com/KCCTdensan/busitsu">https://github.com/KCCTdensan/busitsu</a></p>
            <h2 id="仕様">仕様</h2>
            <p>温度，湿度を測る．</p>
            <p>Prometheusのexporterっぽいやつを実装してる．</p>
            <p>現状，rpi 4B<code>192.168.100.150(hiroshi)</code>で動作中．</p>
            <h2 id="裏仕様">(裏)仕様</h2>
            <p>誰か直してください．</p>
            <ul>
              <li>ファイル(シリアル)を読むスレッドが落ちても何もしない為，センサが抜き差しされるごとに(プロセスの)再起動が必要</li>
              <li>フルのvibe-dに依存してしまっている為ビルドが重い(4Bでも重い)</li>
            </ul>
            <h2 id="インストール">インストール</h2>
            <pre><code># apt-get update
# apt-get install -y runit runit-run git ldc dub
# apt-get install -y build-essential zlib1g-dev libssl-dev # vibe-d
# git clone https://github.com/KCCTdensan/busitsu /opt/busitsu
# cd /opt/busitsu/rpi
# dub build -b release # クッソ時間がかかる
# mkdir -p /etc/sv/busitsu
# touch /etc/sv/busitsu/run
# chmod +x /etc/sv/busitsu/run
</code></pre>
            <p><code>/etc/sv/busitsu/run</code>を以下のようにする．</p>
            <pre><code>#!/usr/bin/env sh
exec /opt/busitsu/rpi/busitsu
</code></pre>
            <p>また，<code>/opt/busitsu/rpi/source/busitsu/app.d</code>の<code>/dev/ttyUSB0</code>を適当なパスに修正する． (当然，編集後にはビルドが必要)</p>
            <p>最後にサービスを有効化・起動させる．</p>
            <pre><code># ln -s /etc/sv/busitsu /etc/service/busitsu
</code></pre>
            <h2 id="prometheusの設定">Prometheusの設定</h2>
            <p><code>prometheus.yml</code>の<code>scrape_configs:</code>に以下を追記する．</p>
            <pre><code>  - job_name: &#39;busitsu&#39;
    static_configs:
    - targets: [&#39;hiroshi.d3bu.net:8080&#39;]
</code></pre>
            <p>サービスをreloadすれば完成．</p>
            <h2 id="おまけ-grafanaの設定">(おまけ) Grafanaの設定</h2>
            <p><code>busitsu_temp{}</code>と<code>busitsu_humid{}</code>を使う．</p>
            <!-- HTML_TAG_END -->
          </main>
        </div>
        <footer class="footer svelte-muqni6">
          <div></div>

          <div class="flex-col">
            <div class="iconLinks svelte-muqni6">
              <a class="smallIcon svelte-muqni6" href="https://github.com/KCCTdensan" alt="GitHub" target="_blank" rel="external"
                ><svg version="1.1" class="fa-icon svelte-1b2zbdf" width="18.599999999999998" height="19.2" role="presentation" viewBox="0 0 496 512" style="font-size: 1.2em">
                  <path
                    id="path-0"
                    d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"
                  ></path></svg
              ></a>
              <a class="smallIcon svelte-muqni6" href="https://twitter.com/intent/user?user_id=444436310" alt="Twitter" target="_blank" rel="external"
                ><svg version="1.1" class="fa-icon svelte-1b2zbdf" width="19.2" height="19.2" role="presentation" viewBox="0 0 512 512" style="font-size: 1.2em">
                  <path
                    id="path-0"
                    d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"
                  ></path></svg
              ></a>
            </div>
            <small class="copyright svelte-muqni6"
              ><span class="inline-block svelte-muqni6">© 1974-2022</span>
              <span class="inline-block svelte-muqni6">KCCTdensan</span>
              <span class="inline-block svelte-muqni6">神戸高専電算部</span></small
            >
          </div>

          <div></div>
        </footer>
      </div>
    </div>

    <script type="module" data-sveltekit-hydrate="1sg6tc">
      import { start } from "/_app/immutable/start-6f4837fc.js"
      start({
        target: document.querySelector('[data-sveltekit-hydrate="1sg6tc"]').parentNode,
        paths: { base: "", assets: "" },
        session: { PLATFORM: "gh-pages" },
        route: true,
        spa: false,
        trailing_slash: "always",
        hydrate: {
          status: 200,
          error: null,
          nodes: [0, 18],
          params: { slug: "rpi-busitsu\u002F" },
          routeId: "inner/infra/[...slug]",
        },
      })
    </script>
    <script type="application/json" sveltekit:data-type="data" sveltekit:data-url="/api/package.json">
      { "status": 200, "statusText": "", "headers": { "content-type": "application/json; charset=utf-8" }, "body": "{\"name\":\"d3bu.net\",\"version\":\"2.1.1\"}" }
    </script>
    <script type="application/json" sveltekit:data-type="data" sveltekit:data-url="/api/articles/infra.json">
      {
        "status": 200,
        "statusText": "",
        "headers": { "content-type": "application/json; charset=utf-8" },
        "body": "{\"data\":[{\"slug\":\"rpi-busitsu\",\"title\":\"ラズパイ部室モニタについて\",\"noRobots\":true,\"date\":\"2022-03-13T00:00:00.000Z\",\"body\":\"\u003Ch1 id=\\\"ラズパイ部室モニタについて\\\">ラズパイ部室モニタについて\u003C/h1>\\n\u003Cp>リポジトリ : \u003Ca href=\\\"https://github.com/KCCTdensan/busitsu\\\">https://github.com/KCCTdensan/busitsu\u003C/a>\u003C/p>\\n\u003Ch2 id=\\\"仕様\\\">仕様\u003C/h2>\\n\u003Cp>温度，湿度を測る．\u003C/p>\\n\u003Cp>Prometheusのexporterっぽいやつを実装してる．\u003C/p>\\n\u003Cp>現状，rpi 4B\u003Ccode>192.168.100.150(hiroshi)\u003C/code>で動作中．\u003C/p>\\n\u003Ch2 id=\\\"裏仕様\\\">(裏)仕様\u003C/h2>\\n\u003Cp>誰か直してください．\u003C/p>\\n\u003Cul>\\n\u003Cli>ファイル(シリアル)を読むスレッドが落ちても何もしない為，センサが抜き差しされるごとに(プロセスの)再起動が必要\u003C/li>\\n\u003Cli>フルのvibe-dに依存してしまっている為ビルドが重い(4Bでも重い)\u003C/li>\\n\u003C/ul>\\n\u003Ch2 id=\\\"インストール\\\">インストール\u003C/h2>\\n\u003Cpre>\u003Ccode># apt-get update\\n# apt-get install -y runit runit-run git ldc dub\\n# apt-get install -y build-essential zlib1g-dev libssl-dev # vibe-d\\n# git clone https://github.com/KCCTdensan/busitsu /opt/busitsu\\n# cd /opt/busitsu/rpi\\n# dub build -b release # クッソ時間がかかる\\n# mkdir -p /etc/sv/busitsu\\n# touch /etc/sv/busitsu/run\\n# chmod +x /etc/sv/busitsu/run\\n\u003C/code>\u003C/pre>\\n\u003Cp>\u003Ccode>/etc/sv/busitsu/run\u003C/code>を以下のようにする．\u003C/p>\\n\u003Cpre>\u003Ccode>#!/usr/bin/env sh\\nexec /opt/busitsu/rpi/busitsu\\n\u003C/code>\u003C/pre>\\n\u003Cp>また，\u003Ccode>/opt/busitsu/rpi/source/busitsu/app.d\u003C/code>の\u003Ccode>/dev/ttyUSB0\u003C/code>を適当なパスに修正する．\\n(当然，編集後にはビルドが必要)\u003C/p>\\n\u003Cp>最後にサービスを有効化・起動させる．\u003C/p>\\n\u003Cpre>\u003Ccode># ln -s /etc/sv/busitsu /etc/service/busitsu\\n\u003C/code>\u003C/pre>\\n\u003Ch2 id=\\\"prometheusの設定\\\">Prometheusの設定\u003C/h2>\\n\u003Cp>\u003Ccode>prometheus.yml\u003C/code>の\u003Ccode>scrape_configs:\u003C/code>に以下を追記する．\u003C/p>\\n\u003Cpre>\u003Ccode>  - job_name: &#39;busitsu&#39;\\n    static_configs:\\n    - targets: [&#39;hiroshi.d3bu.net:8080&#39;]\\n\u003C/code>\u003C/pre>\\n\u003Cp>サービスをreloadすれば完成．\u003C/p>\\n\u003Ch2 id=\\\"おまけ-grafanaの設定\\\">(おまけ) Grafanaの設定\u003C/h2>\\n\u003Cp>\u003Ccode>busitsu_temp{}\u003C/code>と\u003Ccode>busitsu_humid{}\u003C/code>を使う．\u003C/p>\\n\",\"authors\":[]},{\"slug\":\"postgresql\",\"noRobots\":true,\"date\":1640677807960,\"dateUpd\":1640679029558,\"body\":\"\u003Ch1 id=\\\"ポスグレの設定\\\">ポスグレの設定\u003C/h1>\\n\u003Cp>メモ程度．\\ndebian bullseye, pgdb v13を想定\u003C/p>\\n\u003Ch2 id=\\\"リポジトリ\\\">リポジトリ\u003C/h2>\\n\u003Cp>debian公式リポジトリのパッケージは枯れすぎている．\\nプロジェクトのリポジトリを使う．\u003C/p>\\n\u003Cpre>\u003Ccode class=\\\"language-bash\\\">$ curl -L https://www.postgresql.org/media/keys/ACCC4CF8.asc | doas gpg --dearmor -o /usr/share/keyrings/postgr\\nesql.gpg\\n\u003C/code>\u003C/pre>\\n\u003Cp>そしたら\u003Ccode>/etc/apt/sources.list.d/postgresql.list\u003C/code>の内容を以下のようにする．\u003C/p>\\n\u003Cpre>\u003Ccode>deb [signed-by=/usr/share/keyrings/postgresql.gpg] http://apt.postgresql.org/pub/repos/apt bullseye-pgdg main\\n\u003C/code>\u003C/pre>\\n\u003Cp>以下を忘れないように実行．\u003C/p>\\n\u003Cpre>\u003Ccode class=\\\"language-bash\\\">$ sudo apt update\\n\u003C/code>\u003C/pre>\\n\u003Ch2 id=\\\"インストール\\\">インストール\u003C/h2>\\n\u003Cpre>\u003Ccode class=\\\"language-bash\\\">$ sudo apt install postgresql postgresql-common\\n\u003C/code>\u003C/pre>\\n\u003Ch2 id=\\\"設定\\\">設定\u003C/h2>\\n\u003Cp>\u003Ca href=\\\"https://pgtune.leopard.in.ua\\\">PGTune\u003C/a>を使う．\\n生成したものを設定ファイルの末尾に追加する．\u003C/p>\\n\u003Ch2 id=\\\"権限とか\\\">権限とか\u003C/h2>\\n\u003Cp>デフォルトではパスワードで接続できない．\u003C/p>\\n\u003Cpre>\u003Ccode class=\\\"language-diff\\\">- local all all peer\\n+ local all all md5\\n\\n- local replication all peer\\n+ local replication all md5\\n\u003C/code>\u003C/pre>\\n\u003Ch2 id=\\\"いざ接続\\\">いざ接続\u003C/h2>\\n\u003Cp>する前にロールを作成する．\u003C/p>\\n\u003Cpre>\u003Ccode class=\\\"language-bash\\\">$ sudo -u postgres psql\\n\u003C/code>\u003C/pre>\\n\u003Cp>デフォルト設定だと\u003Ccode>postgres\u003C/code>に関してはpeer認証なのでパスワードは聞かれない．\u003C/p>\\n\u003Cpre>\u003Ccode class=\\\"language-sql\\\">&gt; CREATE ROLE hoge WITH LOGIN PASSWORD &#39;hogepass&#39;;\\n\u003C/code>\u003C/pre>\\n\u003Cp>以上．\u003C/p>\\n\u003Ch2 id=\\\"はじめてのdb\\\">はじめてのDB\u003C/h2>\\n\u003Cp>\u003Ccode>ADMIN\u003C/code>のあるロールで操作(さっきの\u003Ccode>postgres\u003C/code>で大丈夫)\u003C/p>\\n\u003Cpre>\u003Ccode class=\\\"language-sql\\\">&gt; CREATE DATABASE hogedb WITH OWNER hoge;\\n\u003C/code>\u003C/pre>\\n\u003Cp>hogeはhogedbの中では好き勝手ができる．\u003C/p>\\n\",\"authors\":[]},{\"slug\":\"prom-pgdb\",\"title\":\"Prometheusとポスグレの連携\",\"noRobots\":true,\"date\":1640675707270,\"dateUpd\":1640688562233,\"body\":\"\u003Ch1 id=\\\"prometheusとポスグレの連携\\\">Prometheusとポスグレの連携\u003C/h1>\\n\u003Ch2 id=\\\"promscale\\\">promscale\u003C/h2>\\n\u003Cp>\u003Ca href=\\\"https://github.com/timescale/promscale\\\">https://github.com/timescale/promscale\u003C/a>\u003C/p>\\n\u003Cp>prometheusとgrafanaの間に入ってくれる(grafana側からは普通のprometheusとして使える)．\\ndebをgithubのリリースページから落とす．\u003C/p>\\n\u003Cp>\u003Ccode>promscale.conf\u003C/code>をこうする．\u003C/p>\\n\u003Cpre>\u003Ccode>PROMSCALE_DB_HOST=&quot;localhost&quot;\\nPROMSCALE_DB_NAME=&quot;prometheus&quot;\\nPROMSCALE_DB_PASSWORD=&quot;hogehoge&quot;\\nPROMSCALE_DB_PORT=&quot;5432&quot;\\nPROMSCALE_DB_SSL_MODE=&quot;allow&quot;\\nPROMSCALE_DB_USER=&quot;prometheus&quot;\\n\u003C/code>\u003C/pre>\\n\u003Cp>また，\u003Ccode>prometheus.yml\u003C/code>に以下を追記する．\u003C/p>\\n\u003Cpre>\u003Ccode class=\\\"language-yaml\\\"># Promscale\\nremote_write:\\n  - url: &quot;http://localhost:9201/write&quot;\\n    remote_timeout: 30s\\n    queue_config:\\n      capacity: 10000\\n      max_samples_per_send: 3000\\n      batch_send_deadline: 10s\\n      min_shards: 4\\n      max_shards: 200\\n      min_backoff: 100ms\\n      max_backoff: 10s\\nremote_read:\\n  - url: &quot;http://localhost:9201/read&quot;\\n    read_recent: true\\n\u003C/code>\u003C/pre>\\n\u003Ch2 id=\\\"pgdbv13を想定に拡張を入れる\\\">pgdb(v13を想定)に拡張を入れる\u003C/h2>\\n\u003Cp>以下を\u003Ccode>/etc/apt/sources.list.d/timescale.list\u003C/code>に書く．\u003C/p>\\n\u003Cpre>\u003Ccode>deb [signed-by=/usr/share/keyrings/timescale.gpg] https://packagecloud.io/timescale/timescaledb/debian/ bullseye main\\n\u003C/code>\u003C/pre>\\n\u003Cp>以下を実行 :\u003C/p>\\n\u003Cpre>\u003Ccode class=\\\"language-bash\\\">$ curl -L https://packagecloud.io/timescale/timescaledb/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/timescale.gpg\\n$ sudo apt update\\n$ sudo apt install timescaledb-2-postgresql-13\\n\u003C/code>\u003C/pre>\\n\u003Cp>postgresql.confの\u003C/p>\\n\u003Cpre>\u003Ccode>#shared_preload_libraries = &#39;&#39;  # (change requires restart)\\n\u003C/code>\u003C/pre>\\n\u003Cp>の行を\u003C/p>\\n\u003Cpre>\u003Ccode>shared_preload_libraries = &#39;timescaledb&#39;        # (change requires restart)\\n\u003C/code>\u003C/pre>\\n\u003Cp>とする．\\nポスグレをrestartしてから対象のDBを作り，\u003C/p>\\n\u003Cpre>\u003Ccode class=\\\"language-sql\\\">&gt; CREATE EXTENSION IF NOT EXISTS timescaledb;\\n\u003C/code>\u003C/pre>\\n\u003Cp>する．\\nそれっぽいのが出る．\u003C/p>\\n\u003Ch2 id=\\\"もう一度ポスグレをいじる\\\">もう一度ポスグレをいじる\u003C/h2>\\n\u003Cp>promscaleも開始前に一応migrate用のSQL走らせてくれるのだが，create roleしようとしやがる．\u003C!-- ふざけんな -->\u003C/p>\\n\u003Cp>まあ動かなけりゃ話にならないのでしゃーなしの権限付与．\u003C/p>\\n\u003Cpre>\u003Ccode class=\\\"language-sql\\\">&gt; ALTER ROLE prometheus WITH CREATEROLE;\\n\u003C/code>\u003C/pre>\\n\u003Ch2 id=\\\"いけた\\\">いけた\u003C/h2>\\n\u003Cp>いけた\u003C/p>\\n\u003Ch2 id=\\\"extensionの更新\\\">Extensionの更新\u003C/h2>\\n\u003Cp>たまに怒られる．\u003C/p>\\n\u003Cpre>\u003Ccode>% doas -u postgres psql -x -d prometheus\\n&gt; ALTER EXTENSION timescaledb UPDATE;\\n\u003C/code>\u003C/pre>\\n\u003Cp>これでヨシ!\u003C/p>\\n\u003Ch2 id=\\\"サービスが何故か起動しない\\\">サービスが何故か起動しない\u003C/h2>\\n\u003Cp>引数も環境変数もユーザーも問題無いのに何故かsystemdのサービスでは起動できない場合がある(かもしれない)．\u003C/p>\\n\u003Cpre>\u003Ccode>% PROMSCALE_DB_HOST=&quot;localhost&quot; PROM... promscale &amp; \\n\u003C/code>\u003C/pre>\\n\u003Cp>とすると起動できる．\u003C/p>\\n\u003C!--\\n### いけなかった: promscaleのmigrate\\n\\n明らかに引数がまずい．\\n対症療法でやったけどまあ動けばいいでしょ(しかし動かない)．\\nバイナリはgithubのリリースページから落としてきた．\\n\\n```bash\\n$ ./prom-migrator --start=0 --reader-url=http://localhost:9201/read --writer-url=http://localhost:9201/write --progress-enabled=false\\n```\\n\\nそれでも動かん．\\n\\nやった後に気付いたが，これ現状動いてるやつをmigradteするやつなのでは．\\n-->\\n\\n\u003Ch2 id=\\\"使ったファイル\\\">使ったファイル\u003C/h2>\\n\u003Cul>\\n\u003Cli>promscale\u003Cul>\\n\u003Cli>\u003Ca href=\\\"https://github.com/timescale/promscale/releases/download/0.7.1/promscale_0.7.1_Linux_x86_64.deb\\\">https://github.com/timescale/promscale/releases/download/0.7.1/promscale_0.7.1_Linux_x86_64.deb\u003C/a>\u003C/li>\\n\u003C/ul>\\n\u003C/li>\\n\u003Cli>prom-migrator(使ってない)\u003Cul>\\n\u003Cli>\u003Ca href=\\\"https://github.com/timescale/promscale/releases/download/0.7.1/prom-migrator_0.0.3_Linux_x86_64\\\">https://github.com/timescale/promscale/releases/download/0.7.1/prom-migrator_0.0.3_Linux_x86_64\u003C/a>\u003C/li>\\n\u003C/ul>\\n\u003C/li>\\n\u003C/ul>\\n\u003Cp>その他はdebian標準のやつ(postgresql-13はpg公式リポジトリのやつ)\u003C/p>\\n\u003Ch2 id=\\\"参考\\\">参考\u003C/h2>\\n\u003Cul>\\n\u003Cli>\u003Ca href=\\\"https://docs.timescale.com/install/latest/self-hosted/installation-debian/#setting-up-the-timescaledb-extension\\\">https://docs.timescale.com/install/latest/self-hosted/installation-debian/#setting-up-the-timescaledb-extension\u003C/a>\u003C/li>\\n\u003Cli>\u003Ca href=\\\"https://docs.timescale.com/timescaledb/latest/how-to-guides/migrate-data/same-db/\\\">https://docs.timescale.com/timescaledb/latest/how-to-guides/migrate-data/same-db/\u003C/a>\u003C/li>\\n\u003C/ul>\\n\",\"authors\":[]},{\"slug\":\"cloudflared\",\"title\":\"Cloudflared\",\"noRobots\":true,\"date\":1628952877912,\"dateUpd\":1640679190738,\"body\":\"\u003Ch1 id=\\\"cloudflared\\\">Cloudflared\u003C/h1>\\n\u003Ch2 id=\\\"サーバー側\\\">サーバー側\u003C/h2>\\n\u003Cpre>\u003Ccode># cloudflared tunnel login\\n# cloudflared tunnel create hoge\\n# cloudflared tunnel route dns hoge hoge.fuga.net # ここらへんは手動でやってもいい\\n# cloudflared tunnel route dns hoge hoge-ssh.fuga.net # 上に同じく\\n# vim ~/.cloudflared/config.yaml\\n# cloudflared service install\\n\u003C/code>\u003C/pre>\\n\u003Ch2 id=\\\"configyaml\\\">config.yaml\u003C/h2>\\n\u003Cpre>\u003Ccode class=\\\"language-yaml\\\">tunnel: piyo\\ncredentials-file: /root/.cloudflared/piyo.json\\n\\ningress:\\n- hostname: hoge.fuga.net\\n  service: http://localhost:80\\n- hostname: hoge-ssh.fuga.net\\n  service: ssh://localhost:22\\n- service: http_status:404\\n\u003C/code>\u003C/pre>\\n\u003Ch2 id=\\\"クライアント側\\\">クライアント側\u003C/h2>\\n\u003Cpre>\u003Ccode>% cloudflared access ssh-config --hostname hoge-ssh.d3bu.net\\n\u003C/code>\u003C/pre>\\n\u003Ch2 id=\\\"参考\\\">参考\u003C/h2>\\n\u003Cul>\\n\u003Cli>\u003Ca href=\\\"https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide\\\">https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide\u003C/a>\u003C/li>\\n\u003Cli>\u003Ca href=\\\"https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/configuration/configuration-file/ingress\\\">https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/configuration/configuration-file/ingress\u003C/a>\u003C/li>\\n\u003Cli>\u003Ca href=\\\"https://zenn.dev/grarich/articles/4fcf016080fbcb\\\">https://zenn.dev/grarich/articles/4fcf016080fbcb\u003C/a>\u003C/li>\\n\u003C/ul>\\n\",\"authors\":[]},{\"slug\":\"servers\",\"title\":\"部室のサーバーについて\",\"noRobots\":true,\"body\":\"\u003Ch1 id=\\\"部室のサーバーについて\\\">部室のサーバーについて\u003C/h1>\\n\u003Cp>部室のインフラ(笑)\u003C/p>\\n\u003Cp>mDNSは未設定．\u003C/p>\\n\u003Ch2 id=\\\"メインサーバー\\\">メインサーバー\u003C/h2>\\n\u003Cul>\\n\u003Cli>\u003Ccode>192.168.100.100(SHOZABURO)\u003C/code>\u003C/li>\\n\u003Cli>CPU : i5-4460 (4C4T)\u003C/li>\\n\u003Cli>メモリ : DDR4 8GB\u003C/li>\\n\u003Cli>\u003Ccode>/\u003C/code>，\u003Ccode>/boot/efi\u003C/code> : 2.5インチSATA SSD(256GB)x1，xfs\u003C/li>\\n\u003Cli>\u003Ccode>/data\u003C/code> : 3.5インチSATA HDD(1TB)x2，btrfs(Data/Metadata/System全部ミラーリング)\u003C/li>\\n\u003C/ul>\\n\u003Ch2 id=\\\"k0sクラスタ\\\">k0sクラスタ\u003C/h2>\\n\u003Cul>\\n\u003Cli>\u003Ccode>192.168.100.150(hiroshi)\u003C/code> : rpi 4B (arm64/4C4T/4GB)，32GB microSDカード\u003C/li>\\n\u003Cli>\u003Ccode>192.168.100.128(tako0)\u003C/code> : rpi 2B (armhf/4C4T/1GB)，32GB microSDカード\u003C/li>\\n\u003Cli>\u003Ccode>192.168.100.129(tako1)\u003C/code> : rpi 2B (armhf/4C4T/1GB)，32GB microSDカード\u003C/li>\\n\u003Cli>\u003Ccode>192.168.100.130(tako2)\u003C/code> : rpi 2B (armhf/4C4T/1GB)，32GB microSDカード\u003C/li>\\n\u003Cli>\u003Ccode>192.168.100.131(tako3)\u003C/code> : rpi 2B (armhf/4C4T/1GB)，32GB microSDカード\u003C/li>\\n\u003Cli>\u003Ccode>192.168.100.132(tako4)\u003C/code> : rpi 2B (armhf/4C4T/1GB)，32GB microSDカード(死亡)\u003C/li>\\n\u003Cli>\u003Ccode>192.168.100.133(tako5)\u003C/code> : rpi 2B (armhf/4C4T/1GB)，32GB microSDカード(死にかけ)\u003C/li>\\n\u003Cli>\u003Ccode>192.168.100.134(tako6)\u003C/code> : rpi 2B (armhf/4C4T/1GB)，16GB microSDカード(スロット破損)\u003C/li>\\n\u003C/ul>\\n\",\"authors\":[]},{\"slug\":\"web\",\"title\":\"運用メモ\",\"author\":\"山D\",\"noRobots\":true,\"date\":\"2021-05-10T00:00:00.000Z\",\"dateUpd\":\"2021-07-21T00:00:00.000Z\",\"body\":\"\u003Cp>\u003Cspan class=\\\"WARN\\\">警告 : ここに書かれている内容は古い\u003C/span>\u003C/p>\\n\u003Ch1 id=\\\"運用メモ\\\">運用メモ\u003C/h1>\\n\u003Cp>マニュアルっぽいことを書こうと思います。\u003C/p>\\n\u003Ch2 id=\\\"開発環境について\\\">開発環境について\u003C/h2>\\n\u003Cp>標準的な、NodeでのGatsbyJSの開発環境があれば問題ありません。\u003C/p>\\n\u003Ch2 id=\\\"記事の追加\\\">記事の追加\u003C/h2>\\n\u003Cp>方法は2つあります。\u003C/p>\\n\u003Cp>1つ目は、/src/pages以下にjsxファイルを作成する方法です。\u003Cbr>JSXの構文が理解できて、Reactの機能を使った高度な動きをさせるページを作りたい場合はこっちを使いましょう。\u003Cbr>しかしこちらの手段を選ぶ人にとっては、ここの説明を読む必要は無いと思われます。\u003C/p>\\n\u003Cp>2つ目は、/src/markdown-pages以下にmarkdownファイルを作成する方法です。\u003Cbr>文章や画像等からなるシンプルなページを、markdownの(比較的簡単な)記法のみで作成することができます。\u003Cbr>このページのソース(このページはmarkdownから生成されています！)を見て頂くと分かる通り、ソースファイル自体は先頭に\u003C/p>\\n\u003Cpre>\u003Ccode>---\\nslug: &quot;filename&quot;\\ntitle: &quot;ページタイトル&quot;\\n---\\n\u003C/code>\u003C/pre>\\n\u003Cp>というメタデータを付加されただけの非常に単純な構造になっています。\u003Cbr>\u003Ccode>slug\u003C/code>というのはそのページにアクセスする為のパスで、\\nここで指定したパスは実際にビルド結果の(\u003Ccode>{MarkdownRemark.frontmatter__slug}.jsx\u003C/code>起点の)ディレクトリ構造に反映されます。\\n(たとえ存在しないサブディレクトリをパスに含めていたとしてもです)\u003Cbr>\u003Ccode>title\u003C/code>は言わずもがな、ページのタイトルです。\\nブラウザタブのタイトルや、OGPのページタイトルにも反映されるようになっています。\u003C/p>\\n\u003Cp>実際にここではmarkdownの記法について説明はしませんが、覚えていて損は無いです。\u003C/p>\\n\u003Ch2 id=\\\"ページのスタイルの修正・改造\\\">ページのスタイルの修正・改造\u003C/h2>\\n\u003Cp>/src/styles/global/global.scssがグローバルに適用されるSCSSファイルです。\\n/src/styles以下の\u003Ccode>hoge.module.scss\u003C/code>にSCSSファイルを置いて、\u003Ccode>import * as styles from &quot;/path/to/hoge.module.scss&quot;\u003C/code>でインポート・適用できます。\u003Cbr>/src/components以下にJSXで書かれた、ページの部品(コンポーネント)やそのテンプレートとなるファイルがあります。\u003Cbr>\u003Ccode>/src/pages/\\\\{MarkdownRemark...\u003C/code>のファイルにはmarkdownで記述されたページ用のテンプレートが書かれています。\\nJSXの方で使われるLayoutに変更を加えた場合は、このファイルにも同様の変更を適用してください。\u003C/p>\\n\u003Cp>ファイルによっては不可解・非効率的な書き方がされているかもしれませんが、何らかの理由があってその表現に落ち着いているという可能性を忘れないでください。\\n明らかに自分が書き直すべきだと感じるのであれば、是非そのコードを実装してください。\u003C/p>\\n\u003Cp>ちなみにCSSのNormalizeには\u003Ca href=\\\"https://krishdevdb.github.io/reseter.css/\\\">reseter.css\u003C/a>を使っています。\\nなんかいい感じらしいので。\u003C/p>\\n\u003Ch2 id=\\\"デプロイ\\\">デプロイ\u003C/h2>\\n\u003Cp>mainブランチとdevブランチは自動でデプロイされます。\\nNetlifyのコンパネから設定を見てください。\u003C/p>\\n\u003Ch2 id=\\\"共通事項\\\">共通事項\u003C/h2>\\n\u003Cul>\\n\u003Cli>Nav内にリンクが無いページはh1タグでページのタイトルを表示するようにしましょう。\u003C/li>\\n\u003Cli>サイト内のリンクにはLinkタグを使用してください。\u003C/li>\\n\u003C/ul>\\n\u003Ch2 id=\\\"メモ\\\">メモ\u003C/h2>\\n\u003Cul>\\n\u003Cli>StaticImageはよくわからんかった。\u003C/li>\\n\u003Cli>OGPは諦めた。react-helmetはJSも読み込んでくれるやつじゃないと使えない。\u003C/li>\\n\u003Cli>文章と単純な画像だけのページはmarkdownで書こう! 楽だし。\u003C/li>\\n\u003C/ul>\\n\",\"authors\":[\"山D\"]}]}"
      }
    </script>
  </body>
</html>
